<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Bot de Trading RL - Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: #27ae60;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .metric-value {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .position-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .position-buy {
            background: #27ae60;
            color: white;
        }

        .position-sell {
            background: #e74c3c;
            color: white;
        }

        .position-close {
            background: #95a5a6;
            color: white;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-start {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-stop {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart {
            height: 400px;
        }

        .trade-history {
            max-height: 400px;
            overflow-y: auto;
        }

        .trade-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.3s ease;
        }

        .trade-item:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateX(5px);
        }

        .trade-item.buy {
            border-left-color: #27ae60;
        }

        .trade-item.sell {
            border-left-color: #e74c3c;
        }

        .trade-time {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .trade-action {
            font-weight: bold;
            text-transform: uppercase;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            animation: slideIn 0.5s ease;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                ü§ñ Bot de Trading RL
                <span class="status-indicator" id="statusIndicator"></span>
            </h1>
            <p style="color: #7f8c8d; margin-top: 10px;">
                Trading automatis√© avec Reinforcement Learning sur EUR/USD via Twelve Data API
            </p>
        </header>

        <div class="controls">
            <button class="btn btn-start" id="startBtn" onclick="startBot()">
                üöÄ D√©marrer le Bot
            </button>
            <button class="btn btn-stop" id="stopBtn" onclick="stopBot()" disabled>
                ‚èπÔ∏è Arr√™ter le Bot
            </button>
        </div>

        <div id="alerts"></div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>üîÑ Phase Actuelle</h3>
                <div class="metric">
                    <span class="metric-label">Phase:</span>
                    <span class="metric-value" id="currentPhase">IDLE</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Cycle #:</span>
                    <span class="metric-value" id="cycleCount">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Position:</span>
                    <span class="metric-value">
                        <span class="position-badge position-close" id="currentPosition">CLOSE</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Dernier Prix:</span>
                    <span class="metric-value" id="lastPrice">0.0000</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pr√©diction:</span>
                    <span class="metric-value" id="lastPrediction">CLOSE</span>
                </div>
            </div>

            <div class="card">
                <h3>üí∞ Performance</h3>
                <div class="metric">
                    <span class="metric-label">Valeur Portefeuille:</span>
                    <span class="metric-value" id="portfolioValue">$1000.00</span>
                </div>
                <div class="metric">
                    <span class="metric-label">R√©compense Totale:</span>
                    <span class="metric-value" id="totalReward">0.0000</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Derni√®re R√©compense:</span>
                    <span class="metric-value" id="lastReward">0.0000</span>
                </div>
                <div class="metric">
                    <span class="metric-label">API Utilis√©e:</span>
                    <span class="metric-value" id="apiUsage">0/800</span>
                </div>
            </div>

            <div class="card">
                <h3>üìà Statistiques</h3>
                <div class="metric">
                    <span class="metric-label">Total Trades:</span>
                    <span class="metric-value" id="totalTrades">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Trades Gagnants:</span>
                    <span class="metric-value" id="winningTrades">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Trades Perdants:</span>
                    <span class="metric-value" id="losingTrades">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Taux de R√©ussite:</span>
                    <span class="metric-value" id="winRate">0%</span>
                </div>
            </div>

            <div class="card">
                <h3>üéì Entra√Ænement</h3>
                <div class="metric">
                    <span class="metric-label">Status:</span>
                    <span class="metric-value" id="trainingStatus">En attente</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Progression:</span>
                    <span class="metric-value" id="trainingProgress">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Temps Restant:</span>
                    <span class="metric-value" id="remainingTime">--:--</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3>üìä Historique des Prix</h3>
            <div id="priceChart" class="chart"></div>
        </div>

        <div class="chart-container">
            <h3>üîÑ Performance des Cycles</h3>
            <div id="cycleChart" class="chart"></div>
        </div>

        <div class="chart-container">
            <h3>üíº Historique des Trades</h3>
            <div id="tradeHistory" class="trade-history">
                <div class="loading">En attente de donn√©es...</div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        let updateInterval;

        // √âtat local
        let botState = {
            isRunning: false,
            currentData: {}
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            setupCharts();
            
            // Configurer les √©couteurs Socket.IO
            socket.on('connect', function() {
                console.log('Connect√© au serveur');
                showAlert('Connect√© au serveur du bot optimis√©', 'success');
                updateStatus(); // Mettre √† jour imm√©diatement
            });

            socket.on('trade_update', function(data) {
                updateTradeDisplay(data);
                addTradeToHistory(data);
                
                // Mettre √† jour le temps restant
                if (data.remaining_time) {
                    document.getElementById('remainingTime').textContent = data.remaining_time;
                }
            });

            socket.on('trading_update', function(data) {
                // Mise √† jour sp√©cifique pour la phase de trading
                updateAllDisplays(data);
                
                // Mettre √† jour le temps restant et API usage
                if (data.remaining_time) {
                    document.getElementById('remainingTime').textContent = data.remaining_time;
                }
                if (data.api_usage) {
                    document.getElementById('apiUsage').textContent = data.api_usage;
                }
            });

            socket.on('training_update', function(data) {
                updateTrainingProgress(data);
                
                // Mettre √† jour le temps restant
                if (data.remaining_time) {
                    document.getElementById('remainingTime').textContent = data.remaining_time;
                }
            });

            // Nouveaux √©v√©nements pour les cycles
            socket.on('cycle_start', function(data) {
                showAlert(`üîÑ D√©but du Cycle #${data.cycle} - Phase: ${data.phase}`, 'info');
                updateStatus();
            });

            socket.on('training_complete', function(data) {
                showAlert(`‚úÖ Entra√Ænement du Cycle #${data.cycle} termin√©!`, 'success');
                updateStatus();
            });

            socket.on('training_error', function(data) {
                showAlert(`‚ùå Erreur d'entra√Ænement Cycle #${data.cycle}: ${data.message}`, 'error');
                updateStatus();
            });

            socket.on('trading_complete', function(data) {
                showAlert(`üíº Trading du Cycle #${data.cycle} termin√©!`, 'success');
                updateStatus();
            });

            socket.on('trading_error', function(data) {
                showAlert(`‚ùå Erreur de trading Cycle #${data.cycle}: ${data.message}`, 'error');
                updateStatus();
            });

            socket.on('cycle_rest', function(data) {
                showAlert(`‚è≥ Pause avant prochain cycle (${data.duration})`, 'info');
                updateStatus();
            });

            socket.on('cycle_error', function(data) {
                showAlert(`‚ùå Erreur Cycle #${data.cycle}: ${data.error}`, 'error');
                updateStatus();
            });

            socket.on('api_limit_reached', function(data) {
                showAlert(`üö® ${data.message} - ${data.api_usage}`, 'warning');
                updateStatus();
            });

            socket.on('status_update', function(data) {
                updateAllDisplays(data);
            });

            // Rafra√Æchir les donn√©es toutes les 5 secondes
            updateInterval = setInterval(updateStatus, 5000);
        });

        // Fonctions de contr√¥le du bot
        async function startBot() {
            try {
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    // Mettre √† jour l'√©tat imm√©diatement
                    setTimeout(() => {
                        updateStatus();
                    }, 1000);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Erreur lors du d√©marrage du bot', 'error');
                console.error('Erreur:', error);
            }
        }

        async function stopBot() {
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'warning');
                    // Mettre √† jour l'√©tat imm√©diatement
                    setTimeout(() => {
                        updateStatus();
                    }, 1000);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('Erreur lors de l\'arr√™t du bot', 'error');
                console.error('Erreur:', error);
            }
        }

        // Mise √† jour des boutons
        function updateButtons() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            startBtn.disabled = botState.isRunning;
            stopBtn.disabled = !botState.isRunning;
        }

        // Mise √† jour du statut
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateAllDisplays(data);
            } catch (error) {
                console.error('Erreur de mise √† jour:', error);
            }
        }

        // Mise √† jour de tous les affichages
        function updateAllDisplays(data) {
            // Phase actuelle et cycle
            const phaseEl = document.getElementById('currentPhase');
            phaseEl.textContent = data.current_phase || 'IDLE';
            
            // Couleur selon la phase
            phaseEl.style.color = {
                'IDLE': '#95a5a6',
                'INITIALIZING': '#f39c12', 
                'TRAINING': '#3498db',
                'TRADING': '#27ae60',
                'RESTING': '#e74c3c'
            }[data.current_phase] || '#95a5a6';
            
            document.getElementById('cycleCount').textContent = data.cycle_count || 0;
            
            // Position actuelle
            const positionEl = document.getElementById('currentPosition');
            positionEl.textContent = data.current_position || 'CLOSE';
            positionEl.className = `position-badge position-${(data.current_position || 'close').toLowerCase()}`;
            
            // Prix et pr√©dictions
            document.getElementById('lastPrice').textContent = (data.last_price || 0).toFixed(5);
            document.getElementById('lastPrediction').textContent = data.last_prediction || 'CLOSE';
            
            // Performance
            document.getElementById('portfolioValue').textContent = `$${(data.portfolio_value || 1000).toFixed(2)}`;
            document.getElementById('totalReward').textContent = (data.total_reward || 0).toFixed(4);
            document.getElementById('lastReward').textContent = (data.last_reward || 0).toFixed(4);
            
            // API
            document.getElementById('apiUsage').textContent = `${data.api_requests_today || 0}/${data.api_limit || 800}`;
            
            // Statistiques
            document.getElementById('totalTrades').textContent = data.total_trades || 0;
            document.getElementById('winningTrades').textContent = data.winning_trades || 0;
            document.getElementById('losingTrades').textContent = data.losing_trades || 0;
            
            const winRate = data.total_trades > 0 ? 
                ((data.winning_trades / data.total_trades) * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
            
            // Entra√Ænement
            const trainingStatus = {
                'IDLE': 'En attente',
                'TRAINING': 'En cours',
                'TRADING': 'Trading actif',
                'RESTING': 'Pause'
            }[data.current_phase] || 'Inconnu';
            
            document.getElementById('trainingStatus').textContent = trainingStatus;
            document.getElementById('trainingProgress').textContent = data.training_progress || 0;
            
            // Barre de progression
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${Math.min(data.training_progress || 0, 100)}%`;
            
            // Mettre √† jour l'√©tat du bot
            botState.isRunning = data.is_running || false;
            updateButtons();
            
            if (data.is_running) {
                document.getElementById('statusIndicator').classList.add('active');
            } else {
                document.getElementById('statusIndicator').classList.remove('active');
            }
            
            // Mettre √† jour les graphiques de cycles
            updateCycleChart(data.cycle_performance || []);
        }

        // Mise √† jour de l'affichage des trades
        function updateTradeDisplay(data) {
            updateAllDisplays(data);
        }

        // Ajouter un trade √† l'historique
        function addTradeToHistory(trade) {
            const historyEl = document.getElementById('tradeHistory');
            
            // Supprimer le message "En attente" si c'est le premier trade
            if (historyEl.querySelector('.loading')) {
                historyEl.innerHTML = '';
            }
            
            const tradeEl = document.createElement('div');
            tradeEl.className = `trade-item ${trade.action.toLowerCase()}`;
            
            const time = new Date(trade.timestamp).toLocaleTimeString();
            const rewardClass = trade.reward >= 0 ? 'positive' : 'negative';
            const rewardSign = trade.reward >= 0 ? '+' : '';
            
            tradeEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span class="trade-action ${trade.action.toLowerCase()}">${trade.action}</span>
                        <span class="trade-time">${time}</span>
                    </div>
                    <div style="text-align: right;">
                        <div>Prix: ${trade.price.toFixed(5)}</div>
                        <div style="color: ${trade.reward >= 0 ? '#27ae60' : '#e74c3c'}">
                            R√©compense: ${rewardSign}${trade.reward.toFixed(4)}
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter au d√©but
            historyEl.insertBefore(tradeEl, historyEl.firstChild);
            
            // Limiter le nombre d'√©l√©ments affich√©s
            while (historyEl.children.length > 50) {
                historyEl.removeChild(historyEl.lastChild);
            }
        }

        // Configuration des graphiques
        function setupCharts() {
            updatePriceChart();
            updateCycleChart();
            loadTradeHistory();
        }

        // Mise √† jour du graphique des prix
        async function updatePriceChart() {
            try {
                const response = await fetch('/api/price_history');
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const times = data.map(d => d.timestamp);
                    const prices = data.map(d => d.price);
                    
                    const trace = {
                        x: times,
                        y: prices,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Prix EUR/USD',
                        line: {
                            color: '#3498db',
                            width: 2
                        }
                    };
                    
                    const layout = {
                        title: 'Prix EUR/USD en temps r√©el',
                        xaxis: {
                            title: 'Temps',
                            type: 'date'
                        },
                        yaxis: {
                            title: 'Prix'
                        },
                        margin: {
                            l: 50,
                            r: 30,
                            t: 30,
                            b: 50
                        }
                    };
                    
                    Plotly.newPlot('priceChart', [trace], layout, {responsive: true});
                }
            } catch (error) {
                console.error('Erreur de chargement du graphique des prix:', error);
            }
        }

        // Mise √† jour du graphique des cycles
        function updateCycleChart(cycleData) {
            if (!cycleData || cycleData.length === 0) {
                return;
            }
            
            const cycles = cycleData.map(d => `Cycle ${d.cycle}`);
            const rewards = cycleData.map(d => d.reward || 0);
            const trades = cycleData.map(d => d.trades_made || 0);
            
            const trace1 = {
                x: cycles,
                y: rewards,
                type: 'bar',
                name: 'R√©compense',
                marker: {
                    color: '#27ae60'
                }
            };
            
            const trace2 = {
                x: cycles,
                y: trades,
                type: 'bar',
                name: 'Trades',
                marker: {
                    color: '#3498db'
                }
            };
            
            const layout = {
                title: 'Performance par Cycle',
                xaxis: {
                    title: 'Cycles'
                },
                yaxis: {
                    title: 'Valeur'
                },
                barmode: 'group',
                margin: {
                    l: 50,
                    r: 30,
                    t: 30,
                    b: 50
                }
            };
            
            Plotly.newPlot('cycleChart', [trace1, trace2], layout, {responsive: true});
        }

        // Charger l'historique des trades
        async function loadTradeHistory() {
            try {
                const response = await fetch('/api/trade_history');
                const data = await response.json();
                
                const historyEl = document.getElementById('tradeHistory');
                
                if (data && data.length > 0) {
                    historyEl.innerHTML = '';
                    data.reverse().forEach(trade => addTradeToHistory(trade));
                }
            } catch (error) {
                console.error('Erreur de chargement de l\'historique:', error);
            }
        }

        // Mise √† jour de la progression d'entra√Ænement
        function updateTrainingProgress(data) {
            document.getElementById('trainingProgress').textContent = data.progress || 0;
            document.getElementById('progressBar').style.width = `${Math.min(data.progress || 0, 100)}%`;
            
            // Mettre √† jour le status si n√©cessaire
            if (data.phase) {
                const statusMap = {
                    'TRAINING': 'Entra√Ænement en cours...',
                    'TRADING': 'Trading actif...',
                    'RESTING': 'Pause...',
                    'IDLE': 'En attente'
                };
                document.getElementById('trainingStatus').textContent = statusMap[data.phase] || 'Inconnu';
            }
        }

        // Affichage des alertes
        function showAlert(message, type) {
            const alertsEl = document.getElementById('alerts');
            const alertEl = document.createElement('div');
            alertEl.className = `alert alert-${type}`;
            alertEl.textContent = message;
            
            alertsEl.appendChild(alertEl);
            
            // Auto-suppression apr√®s 5 secondes
            setTimeout(() => {
                if (alertEl.parentNode) {
                    alertEl.parentNode.removeChild(alertEl);
                }
            }, 5000);
        }

        // Nettoyage lors de la d√©connexion
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
